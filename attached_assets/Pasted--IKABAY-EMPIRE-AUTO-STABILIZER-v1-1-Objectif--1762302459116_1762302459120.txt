##############################################
# ğŸ¤– IKABAY EMPIRE AUTO-STABILIZER v1.1
# Objectif : surveillance IA, redÃ©marrage auto, logs + optimisation continue
##############################################

echo "ğŸ§  Activation du module dâ€™autostabilisation IA..."

mkdir -p lib/empire scripts logs app/api/empire

##############################################
# 1ï¸âƒ£ WATCHDOG â€” DÃ‰TECTION ET REDÃ‰MARRAGE AUTOMATIQUE
##############################################
cat > scripts/empire-watchdog.sh << 'EOF'
#!/bin/bash
PORT=${1:-5000}
LOGFILE="./logs/empire-watchdog.log"

while true; do
  if lsof -i:$PORT >/dev/null; then
    echo "$(date) âœ… Port $PORT actif, tout est OK" >> $LOGFILE
  else
    echo "$(date) âš ï¸ Port $PORT inactif, tentative de redÃ©marrage..." >> $LOGFILE
    nohup npm run start >/dev/null 2>&1 &
    echo "$(date) ğŸš€ Serveur redÃ©marrÃ© automatiquement" >> $LOGFILE
  fi
  sleep 60
done
EOF
chmod +x scripts/empire-watchdog.sh

##############################################
# 2ï¸âƒ£ MODULE IA DE SUPERVISION (OPENAI + GEMINI)
##############################################
cat > lib/empire/ai-supervisor.ts << 'EOF'
import OpenAI from "openai";
import fetch from "node-fetch";

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const geminiKey = process.env.GEMINI_API_KEY;

export async function analyzeSystemHealth(metrics: any) {
  try {
    const geminiPrompt = `
    Analyse ces donnÃ©es serveur :
    ${JSON.stringify(metrics, null, 2)}
    Fournis : 1ï¸âƒ£ Score de stabilitÃ© (0-100)
              2ï¸âƒ£ Causes possibles dâ€™instabilitÃ©
              3ï¸âƒ£ Recommandations dâ€™optimisation
    `;

    const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" + geminiKey, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: [{ parts: [{ text: geminiPrompt }] }] }),
    });

    const geminiData = await response.json();
    const analysisText = geminiData?.candidates?.[0]?.content?.parts?.[0]?.text || "Aucune analyse";

    const openaiResponse = await openai.responses.create({
      model: "gpt-4o-mini",
      input: `SynthÃ©tise lâ€™analyse suivante pour lâ€™administrateur Ikabay :\n${analysisText}`,
    });

    return openaiResponse.output_text || analysisText;
  } catch (err) {
    console.error("Erreur analyse IA :", err);
    return "âš ï¸ Erreur IA";
  }
}
EOF

##############################################
# 3ï¸âƒ£ API PUBLIQUE DE SURVEILLANCE
##############################################
cat > app/api/empire/status/route.ts << 'EOF'
import { NextResponse } from "next/server";
import os from "os";
import { analyzeSystemHealth } from "@/lib/empire/ai-supervisor";

export async function GET() {
  const metrics = {
    uptime: process.uptime(),
    memory: process.memoryUsage(),
    cpu: os.loadavg(),
    timestamp: new Date().toISOString(),
  };

  const iaAnalysis = await analyzeSystemHealth(metrics);

  return NextResponse.json({
    system: metrics,
    ai_report: iaAnalysis,
    status: "âœ… Empire stabilisÃ© et surveillÃ© en temps rÃ©el",
  });
}
EOF

##############################################
# 4ï¸âƒ£ SÃ‰CURITÃ‰ + VARIABLES Dâ€™ENVIRONNEMENT
##############################################
cat >> .env << 'EOF'

# ğŸŒ EMPIRE AUTO-STABILIZER
EMPIRE_API_TOKEN=secure_empire_token
OPENAI_API_KEY=your_openai_key_here
GEMINI_API_KEY=your_gemini_key_here
EOF

##############################################
# 5ï¸âƒ£ CRON AUTOMATIQUE (SCAN TOUTES LES 2H)
##############################################
cat > scripts/empire-cron.sh << 'EOF'
#!/bin/bash
LOGFILE="./logs/empire-cron.log"
while true; do
  echo "$(date) ğŸ” Scan IA Empire en cours..." >> $LOGFILE
  curl -H "Authorization: Bearer $EMPIRE_API_TOKEN" \
  http://localhost:5000/api/empire/status >> $LOGFILE 2>&1
  sleep 7200  # toutes les 2h
done
EOF
chmod +x scripts/empire-cron.sh

##############################################
# 6ï¸âƒ£ MISE EN ROUTE
##############################################
echo "âœ… Configuration terminÃ©e !"
echo "DÃ©marrage du Watchdog et du Cron..."
nohup ./scripts/empire-watchdog.sh 5000 >/dev/null 2>&1 &
nohup ./scripts/empire-cron.sh >/dev/null 2>&1 &

echo "ğŸŒ Empire surveillÃ© : http://localhost:5000/api/empire/status"
echo "ğŸ§  Rapport IA disponible toutes les 2h dans logs/empire-cron.log"
